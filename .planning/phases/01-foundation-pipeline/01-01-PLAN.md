---
phase: 01-foundation-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pom.xml
  - src/main/java/com/example/print/pdf/PdfGenerator.java
  - src/main/java/com/example/print/qr/QrCodeGenerator.java
  - src/main/resources/fonts/DejaVuSans.ttf
  - src/test/java/com/example/print/pdf/PdfGeneratorTest.java
  - src/test/java/com/example/print/qr/QrCodeGeneratorTest.java
  - src/test/resources/templates/test-minimal.html
  - src/test/resources/css/test-minimal.css
  - CSS-CONSTRAINTS.md
autonomous: true

must_haves:
  truths:
    - "Maven project compiles with `mvn compile` without errors"
    - "PdfGenerator produces a valid PDF byte array from hardcoded HTML containing German umlauts"
    - "QrCodeGenerator produces a base64 PNG data URI that starts with 'data:image/png;base64,'"
    - "A minimal HTML template renders to a PDF file with embedded font showing umlauts correctly"
    - "CSS constraints are documented (no Flexbox, no Grid, CSS 2.1 only)"
  artifacts:
    - path: "pom.xml"
      provides: "Maven project with all dependencies"
      contains: "io.github.openhtmltopdf"
    - path: "src/main/java/com/example/print/pdf/PdfGenerator.java"
      provides: "HTML+CSS to PDF rendering"
      exports: ["PdfGenerator"]
    - path: "src/main/java/com/example/print/qr/QrCodeGenerator.java"
      provides: "QR code generation as base64 data URI"
      exports: ["QrCodeGenerator"]
    - path: "CSS-CONSTRAINTS.md"
      provides: "CSS limitations reference"
  key_links:
    - from: "PdfGeneratorTest"
      to: "PdfGenerator"
      via: "generates PDF from HTML string"
    - from: "QrCodeGeneratorTest"
      to: "QrCodeGenerator"
      via: "generates base64 data URI from text input"
---

<objective>
Set up the Maven project with all dependencies, create the PDF generation pipeline core (PdfGenerator + QrCodeGenerator), embed a Unicode font, and establish CSS constraints documentation.

Purpose: This is the foundation everything else builds on. Font registration, resource resolution, and the PDF rendering pipeline must work before any template work begins. Discovering CSS constraints or font issues later requires rework of all templates.

Output: Compilable Maven project, working PdfGenerator and QrCodeGenerator with passing unit tests, DejaVuSans font embedded, CSS constraints documented.
</objective>

<execution_context>
@/Users/markus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/markus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Maven project with all dependencies and font</name>
  <files>pom.xml, src/main/resources/fonts/DejaVuSans.ttf, CSS-CONSTRAINTS.md</files>
  <action>
Create the Maven project structure with pom.xml:

**pom.xml requirements:**
- Parent: `org.springframework.boot:spring-boot-starter-parent:3.5.10`
- Java version: 21
- Group: `com.example`, Artifact: `print`
- Dependencies (compile scope):
  - `org.springframework.boot:spring-boot-starter-thymeleaf` (version managed by parent)
  - `io.github.openhtmltopdf:openhtmltopdf-pdfbox:1.1.37` (explicit version pin — NOTE: group ID changed from `com.openhtmltopdf` to `io.github.openhtmltopdf`)
  - `com.google.zxing:core:3.5.4` (explicit version pin)
  - `com.google.zxing:javase:3.5.4` (explicit version pin)
- Dependencies (test scope):
  - `org.springframework.boot:spring-boot-starter-test` (version managed by parent)
- Do NOT include `spring-boot-maven-plugin` (no runnable application)
- Do NOT include `spring-boot-starter-web` (no web layer)

**Font file:**
- Download DejaVuSans.ttf to `src/main/resources/fonts/DejaVuSans.ttf`
- Use curl to download from GitHub: `https://github.com/dejavu-fonts/dejavu-fonts/raw/master/ttf/DejaVuSans.ttf`
- This font has full Unicode coverage including German umlauts

**CSS-CONSTRAINTS.md (project root):**
Create a concise reference document listing what CSS features OpenHTMLtoPDF supports and does not support:
- Supported: CSS 2.1 properties, `@page` rules (size, margins, page-break-before/after), `column-count`, floats, `display: table/table-cell/inline-block`, `position: absolute/relative` within page context, base64 data URIs for images
- NOT supported: `display: flex`, `display: grid`, CSS custom properties (var()), CSS animations/transitions, JavaScript, viewport units (vw, vh)
- Recommendation: Always test in PDF output, never rely on browser preview alone

Create the directory structure:
```
src/main/java/com/example/print/pdf/
src/main/java/com/example/print/qr/
src/main/resources/fonts/
src/test/java/com/example/print/pdf/
src/test/java/com/example/print/qr/
src/test/resources/templates/
src/test/resources/css/
```
  </action>
  <verify>
Run `mvn compile` — must succeed with no errors.
Verify `src/main/resources/fonts/DejaVuSans.ttf` exists and is > 500KB.
Verify `CSS-CONSTRAINTS.md` exists in project root.
  </verify>
  <done>Maven project compiles. All dependencies resolve. Font file present. CSS constraints documented.</done>
</task>

<task type="auto">
  <name>Task 2: Implement PdfGenerator, QrCodeGenerator, and unit tests</name>
  <files>
    src/main/java/com/example/print/pdf/PdfGenerator.java,
    src/main/java/com/example/print/qr/QrCodeGenerator.java,
    src/test/java/com/example/print/pdf/PdfGeneratorTest.java,
    src/test/java/com/example/print/qr/QrCodeGeneratorTest.java,
    src/test/resources/templates/test-minimal.html,
    src/test/resources/css/test-minimal.css
  </files>
  <action>
**QrCodeGenerator.java** (`com.example.print.qr`):
- Single static method: `public static String generateDataUri(String text, int size)`
- Uses ZXing `QRCodeWriter` to create `BitMatrix`
- Uses `MatrixToImageWriter.toBufferedImage(matrix)` to get BufferedImage
- Writes to `ByteArrayOutputStream` as PNG via `ImageIO.write()`
- Returns `"data:image/png;base64," + Base64.getEncoder().encodeToString(bytes)`
- Default size parameter suggestion: 300 (pixels)

**PdfGenerator.java** (`com.example.print.pdf`):
- Method: `public byte[] generatePdf(String html, String baseUri)`
- Creates `PdfRendererBuilder` (from `io.github.openhtmltopdf.pdfboxout.PdfRendererBuilder`)
- Calls `builder.useFastMode()` (try this; if method doesn't exist in 1.1.37 API, remove it)
- Registers DejaVuSans font: load font from classpath `fonts/DejaVuSans.ttf` using `getClass().getClassLoader().getResourceAsStream()`, write to temp file, register with `builder.useFont(new File(tempFile), "DejaVuSans")`
- Sets HTML with `builder.withHtmlContent(html, baseUri)`
- Renders to `ByteArrayOutputStream` via `builder.toStream(os)` then `builder.run()`
- Returns the byte array
- Handle cleanup of temp font file in finally block

**test-minimal.html** (XHTML-compliant, in `src/test/resources/templates/`):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="../css/test-minimal.css"/>
    <title>Minimal Test</title>
</head>
<body>
    <h1>PDF Generation Test</h1>
    <p>German umlauts: Ä Ö Ü ä ö ü ß</p>
    <p>Name: Max Müller</p>
    <p>Address: Königstraße 42, München</p>
</body>
</html>
```

**test-minimal.css** (in `src/test/resources/css/`):
```css
@page { size: A4; margin: 2cm; }
body { font-family: 'DejaVuSans', sans-serif; font-size: 12pt; }
h1 { font-size: 18pt; margin-bottom: 1cm; }
```

**QrCodeGeneratorTest.java:**
- Test `generateDataUri` returns string starting with `"data:image/png;base64,"`
- Test the base64 portion decodes to valid PNG bytes (first 8 bytes match PNG signature)
- Test with size 300 for a sample URL like `"https://example.com/doc/12345"`

**PdfGeneratorTest.java:**
- Test: construct hardcoded HTML string (XHTML with DejaVuSans font-family, containing "Müller" and "Königstraße"), call `generatePdf()` with null baseUri, verify returned byte[] starts with PDF magic bytes `%PDF`
- Test: load `test-minimal.html` from classpath, compute baseUri as `getClass().getClassLoader().getResource("templates/").toExternalForm()`, call `generatePdf()`, write output to `target/test-output/test-minimal.pdf`, verify file exists and is > 1KB
- Create `target/test-output/` directory in test setup (`@BeforeAll`)

IMPORTANT: All HTML must be well-formed XHTML. Self-close void elements: `<br/>`, `<img/>`, `<meta/>`, `<link/>`.
  </action>
  <verify>
Run `mvn test` — all tests must pass.
Verify `target/test-output/test-minimal.pdf` is created and is a valid PDF (> 1KB, starts with %PDF).
  </verify>
  <done>
QrCodeGenerator produces valid base64 PNG data URIs. PdfGenerator renders HTML to valid PDFs with DejaVuSans font. test-minimal.pdf exists in target/test-output/ with correct German umlauts. All unit tests pass.
  </done>
</task>

</tasks>

<verification>
1. `mvn clean test` passes with 0 failures
2. `target/test-output/test-minimal.pdf` exists, is > 1KB, and opens in a PDF viewer showing German umlauts correctly
3. CSS-CONSTRAINTS.md exists in project root with documented limitations
4. No Flexbox or Grid CSS used anywhere
</verification>

<success_criteria>
- Maven project compiles and all tests pass on first `mvn clean test`
- PdfGenerator produces valid PDFs from HTML input
- QrCodeGenerator produces valid base64 PNG data URIs
- DejaVuSans font renders German umlauts (Ä, Ö, Ü, ä, ö, ü, ß) correctly in PDF output
- CSS constraints documented for future template development reference
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-pipeline/01-01-SUMMARY.md`
</output>
