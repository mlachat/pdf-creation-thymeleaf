---
phase: 01-foundation-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/main/java/com/example/print/template/ThymeleafRenderer.java
  - src/test/java/com/example/print/template/ThymeleafRendererTest.java
  - src/test/java/com/example/print/PipelineIntegrationTest.java
  - src/test/resources/templates/test-thymeleaf.html
  - src/test/resources/css/test-thymeleaf.css
autonomous: true

must_haves:
  truths:
    - "Thymeleaf processes an HTML template with th:text placeholders and returns rendered HTML"
    - "A template with th:text placeholders renders to a PDF containing the expected dynamic text"
    - "German umlauts from Thymeleaf model data appear correctly in the final PDF"
    - "A QR code generated via ZXing appears as a visible image in the PDF output"
    - "Resources (CSS, fonts) resolve correctly from test classpath via base URI"
  artifacts:
    - path: "src/main/java/com/example/print/template/ThymeleafRenderer.java"
      provides: "Thymeleaf template processing"
      exports: ["ThymeleafRenderer"]
    - path: "src/test/java/com/example/print/PipelineIntegrationTest.java"
      provides: "End-to-end pipeline test"
    - path: "src/test/resources/templates/test-thymeleaf.html"
      provides: "Thymeleaf test template with placeholders"
  key_links:
    - from: "ThymeleafRenderer"
      to: "SpringTemplateEngine"
      via: "ClassLoaderTemplateResolver configured for templates/ prefix"
    - from: "PipelineIntegrationTest"
      to: "ThymeleafRenderer -> PdfGenerator"
      via: "renders template then generates PDF"
    - from: "PipelineIntegrationTest"
      to: "QrCodeGenerator"
      via: "generates QR data URI, passes in model map"
---

<objective>
Add Thymeleaf template rendering to the pipeline and validate the complete end-to-end flow: Thymeleaf fills placeholders (including a QR code data URI) -> PdfGenerator renders to PDF with correct fonts and resource resolution.

Purpose: This completes the Phase 1 pipeline. After this plan, all building blocks are proven: template processing, QR code embedding, font rendering, and PDF generation. Phase 2 can build real templates with confidence.

Output: Working ThymeleafRenderer, integration test producing a PDF with dynamic data + QR code, all Phase 1 requirements validated.
</objective>

<execution_context>
@/Users/markus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/markus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/research/ARCHITECTURE.md
@.planning/phases/01-foundation-pipeline/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ThymeleafRenderer with standalone configuration</name>
  <files>
    src/main/java/com/example/print/template/ThymeleafRenderer.java,
    src/test/java/com/example/print/template/ThymeleafRendererTest.java,
    src/test/resources/templates/test-thymeleaf.html,
    src/test/resources/css/test-thymeleaf.css
  </files>
  <action>
**ThymeleafRenderer.java** (`com.example.print.template`):
- Constructor sets up `SpringTemplateEngine` with `ClassLoaderTemplateResolver`:
  - Prefix: `templates/` (resolves from classpath)
  - Suffix: `.html`
  - Template mode: `HTML` (Thymeleaf's default mode, produces well-formed output)
  - Character encoding: `UTF-8`
- Method: `public String render(String templateName, Map&lt;String, Object&gt; variables)`
  - Creates Thymeleaf `Context`, sets all variables
  - Calls `engine.process(templateName, context)`
  - Returns the rendered HTML string
- No Spring Boot auto-config needed — this is a standalone POJO wrapping Thymeleaf

**test-thymeleaf.html** (XHTML-compliant, in `src/test/resources/templates/`):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="../css/test-thymeleaf.css"/>
    <title th:text="${title}">Default Title</title>
</head>
<body>
    <h1 th:text="${heading}">Heading</h1>
    <div class="address-block">
        <p th:text="${name}">Name</p>
        <p th:text="${street}">Street</p>
        <p th:text="${city}">City</p>
    </div>
    <div class="content">
        <p th:text="${message}">Message content</p>
    </div>
    <div class="qr-section" th:if="${qrCodeDataUri}">
        <img th:src="${qrCodeDataUri}" alt="QR Code" style="width: 150px; height: 150px;"/>
    </div>
</body>
</html>
```

**test-thymeleaf.css** (in `src/test/resources/css/`):
```css
@page { size: A4; margin: 2cm; }
body { font-family: 'DejaVuSans', sans-serif; font-size: 12pt; }
h1 { font-size: 18pt; margin-bottom: 1cm; }
.address-block { margin-bottom: 1cm; }
.content { margin-bottom: 1cm; }
.qr-section { margin-top: 1cm; text-align: center; }
```

**ThymeleafRendererTest.java:**
- Test: render `test-thymeleaf` with model containing `name: "Max Müller"`, `street: "Königstraße 42"`, `city: "80331 München"`, `heading: "Testbrief"`, `message: "Dies ist ein Test."`, `title: "Test"` — verify returned HTML contains "Max Müller" and "Königstraße 42" (literal strings, not th:text attributes)
- Test: render with `qrCodeDataUri: null` — verify the qr-section div is NOT present in output (th:if removes it)
- Test: render with `qrCodeDataUri: "data:image/png;base64,ABC"` — verify the img tag with that src IS present in output
  </action>
  <verify>
Run `mvn test -pl . -Dtest=ThymeleafRendererTest` — all tests pass.
Rendered HTML contains actual data values, not Thymeleaf placeholder expressions.
  </verify>
  <done>ThymeleafRenderer processes templates with th:text placeholders. Conditional th:if blocks work (QR section shows/hides). German umlauts pass through correctly in rendered HTML.</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end pipeline integration test</name>
  <files>
    src/test/java/com/example/print/PipelineIntegrationTest.java
  </files>
  <action>
**PipelineIntegrationTest.java** (`com.example.print`):
Full pipeline test that exercises: QrCodeGenerator -> ThymeleafRenderer -> PdfGenerator -> file output.

Test method `testFullPipeline`:
1. Generate QR code: `QrCodeGenerator.generateDataUri("https://example.com/doc/12345", 300)`
2. Build model map with:
   - `name: "Hans Müller"`
   - `street: "Königstraße 42"`
   - `city: "80331 München"`
   - `heading: "Testbrief"`
   - `title: "Pipeline Test"`
   - `message: "Sehr geehrter Herr Müller, dies ist ein automatisch generierter Testbrief."`
   - `qrCodeDataUri: (the generated QR data URI)`
3. Render template: `ThymeleafRenderer.render("test-thymeleaf", model)`
4. Compute base URI: `getClass().getClassLoader().getResource("templates/").toExternalForm()`
5. Generate PDF: `PdfGenerator.generatePdf(renderedHtml, baseUri)`
6. Write to `target/test-output/test-pipeline.pdf`
7. Assertions:
   - PDF bytes start with `%PDF`
   - File size > 5KB (contains font subset + QR image)
   - File exists and is readable

Test method `testPdfContainsExpectedText` (if PDFBox is available as transitive dep):
- Use Apache PDFBox `Loader.loadPDF()` (or `PDDocument.load()`) to open the generated PDF
- Extract text with `PDFTextStripper`
- Assert text contains "Hans Müller", "Königstraße", "München"
- This validates the font renders umlauts correctly (not just that the PDF file exists)

`@BeforeAll`: Create `target/test-output/` directory if it doesn't exist.

IMPORTANT: The base URI must point to the templates/ directory so that the relative CSS path `../css/test-thymeleaf.css` resolves correctly. If CSS doesn't resolve, try setting base URI to the root of test-classes instead: `getClass().getClassLoader().getResource("").toExternalForm()`. Experiment to find what works — this is a known pitfall.
  </action>
  <verify>
Run `mvn clean test` — ALL tests pass (previous plan's tests + new tests).
Verify `target/test-output/test-pipeline.pdf` exists, is > 5KB.
Open the PDF manually or verify with PDFBox text extraction that "Müller" and "Königstraße" appear.
  </verify>
  <done>
Full pipeline works end-to-end: Thymeleaf fills placeholders, QR code appears in PDF, German umlauts render correctly with DejaVuSans font, CSS resolves from classpath. Both test-minimal.pdf and test-pipeline.pdf exist in target/test-output/.
  </done>
</task>

</tasks>

<verification>
1. `mvn clean test` passes with 0 failures (all tests from both plans)
2. `target/test-output/test-pipeline.pdf` contains:
   - Rendered text with German umlauts (Müller, Königstraße, München)
   - A visible QR code image
   - Proper A4 page layout with margins
3. ThymeleafRenderer correctly fills placeholders and handles conditional blocks
4. CSS and font resources resolve from test classpath
</verification>

<success_criteria>
- ThymeleafRenderer processes HTML templates with th:text placeholders producing rendered HTML
- Full pipeline (QR generation -> Thymeleaf rendering -> PDF generation) works end-to-end
- PDF output contains expected dynamic text including German umlauts
- QR code appears as visible image in PDF
- CSS resolves correctly via base URI from test classpath
- All tests pass with `mvn clean test`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-pipeline/01-02-SUMMARY.md`
</output>
