---
phase: 02-demo-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/resources/templates/template-a.html
  - src/test/resources/css/template-a.css
  - src/test/resources/docx/template-a.docx
autonomous: true

must_haves:
  truths:
    - "Template A renders as a 2-page PDF with a visible page break between pages"
    - "QR code appears as a visible image on the first page"
    - "Address and name placeholders are filled with Thymeleaf th:text"
    - "Conditional content blocks show or hide based on data values via th:if"
    - "Running header and footer appear on both pages with page numbers"
    - "A .docx source artifact exists representing the customer-provided original"
  artifacts:
    - path: "src/test/resources/templates/template-a.html"
      provides: "2-page XHTML template with Thymeleaf placeholders, QR code, conditional blocks, page break"
      contains: "page-break-before"
    - path: "src/test/resources/css/template-a.css"
      provides: "Print-ready CSS with @page A4, margins, running header/footer, page counter"
      contains: "@page"
    - path: "src/test/resources/docx/template-a.docx"
      provides: "Demo Word document representing customer-provided 2-page letter template"
  key_links:
    - from: "src/test/resources/templates/template-a.html"
      to: "src/test/resources/css/template-a.css"
      via: "link rel=stylesheet with path relative to test-classes root"
      pattern: 'href="css/template-a.css"'
---

<objective>
Create Template A: a 2-page formal letter HTML template with Thymeleaf placeholders, QR code embedding, conditional content blocks, running headers/footers, and a companion .docx source artifact.

Purpose: Proves multi-page PDF rendering with page breaks, running headers/footers via @page margin boxes, conditional content, and QR code embedding -- the most feature-rich template in the demo.
Output: template-a.html, template-a.css, template-a.docx
</objective>

<execution_context>
@/Users/markus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/markus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-pipeline/01-01-SUMMARY.md
@.planning/phases/01-foundation-pipeline/01-02-SUMMARY.md

Key patterns from Phase 1:
- XHTML compliance: all templates must be well-formed XML with self-closed void elements
- CSS link uses path relative to test-classes root: href="css/filename.css" (NOT ../css/)
- Template resolver prefix is "templates/" so template name is just "template-a" (no path, no .html)
- Pipeline: QrCodeGenerator.generateDataUri() -> ThymeleafRenderer.render() -> PdfGenerator.generatePdf()
- Base URI points to test-classes root for resource resolution
- Font: DejaVuSans, font-family: 'DejaVuSans', sans-serif
- CSS 2.1 ONLY: no Flexbox, no Grid. Use tables for layout structure.

Concerns from STATE.md:
- CSS @page margin boxes with running() elements have MEDIUM confidence -- may need iteration
- If running headers/footers via @page margin boxes don't work in OpenHTMLtoPDF, use a table-based header/footer within the page body as fallback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Template A HTML and CSS</name>
  <files>
    src/test/resources/templates/template-a.html
    src/test/resources/css/template-a.css
  </files>
  <action>
Create template-a.css with print-ready A4 styling:
- `@page { size: A4; margin: 2.5cm 2cm 2.5cm 2cm; }` for standard letter margins
- Attempt `@page` margin boxes for running header/footer:
  - `@page { @top-center { content: "Company Name — Confidential"; font-size: 8pt; } }`
  - `@page { @bottom-right { content: "Page " counter(page) " of " counter(pages); font-size: 8pt; } }`
- If `@page` margin boxes cause rendering errors or are invisible in OpenHTMLtoPDF, fall back to:
  - A fixed-position header div: `position: fixed; top: 0; ...` or a `running()` element approach
  - A fixed-position footer div with page counter
  - Document which approach was used and why
- Body: `font-family: 'DejaVuSans', sans-serif; font-size: 11pt; line-height: 1.5;`
- `.page-break { page-break-before: always; }` for multi-page support
- Address block styling, QR code section, content paragraph styles
- Conditional section styling (e.g., `.notice-block` for optional content)

Create template-a.html as well-formed XHTML:
- XML declaration and proper namespaces: `xmlns:th="http://www.thymeleaf.org"`
- CSS link: `<link rel="stylesheet" href="css/template-a.css"/>`
- **Page 1 — Letter front:**
  - Company header area with company name (static text)
  - Address block with Thymeleaf placeholders: `th:text="${recipientName}"`, `th:text="${recipientStreet}"`, `th:text="${recipientCity}"`
  - Date line: `th:text="${date}"`
  - Subject line: `th:text="${subject}"`
  - Letter body paragraph: `th:text="${bodyText}"`
  - Conditional notice block: `<div th:if="${showNotice}" class="notice-block"><p th:text="${noticeText}">Notice</p></div>`
  - QR code: `<img th:src="${qrCodeDataUri}" alt="QR Code" style="width: 150px; height: 150px;"/>`
  - Sender name: `th:text="${senderName}"`
- **Page 2 — Additional information:**
  - `<div class="page-break">` to force page break
  - Heading: "Anhang / Zusatzinformationen" (Appendix / Additional Information)
  - Terms and conditions paragraph: `th:text="${termsText}"`
  - Second conditional block: `<div th:if="${showDisclaimer}"><p th:text="${disclaimerText}">Disclaimer</p></div>`
  - Footer contact info: `th:text="${contactInfo}"`

Use German-language content for placeholder defaults (this is a German business letter demo):
- Default name: "Max Mustermann"
- Default street: "Musterstraße 42"
- Default city: "80331 München"
- All self-closing void elements (meta, link, img, br, hr)
  </action>
  <verify>
Verify template is well-formed XHTML:
```bash
cd /Users/markus/Documents/git/print && xmllint --noout src/test/resources/templates/template-a.html 2>&1 || echo "XHTML validation failed"
```

Verify CSS file exists and contains @page rule:
```bash
grep -c "@page" src/test/resources/css/template-a.css
```

Run existing tests to ensure nothing is broken:
```bash
cd /Users/markus/Documents/git/print && mvn test -q 2>&1 | tail -5
```
  </verify>
  <done>
- template-a.html is well-formed XHTML with Thymeleaf placeholders for all data fields
- template-a.css has @page A4 rules with margins and header/footer (via margin boxes or fallback)
- Page break CSS class exists for multi-page rendering
- Conditional th:if blocks present for showNotice and showDisclaimer
- QR code img tag with th:src for data URI embedding
- Existing 9 tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Template A .docx source artifact</name>
  <files>
    src/test/resources/docx/template-a.docx
  </files>
  <action>
Create a minimal .docx file programmatically using Apache POI (already available as transitive dependency via Spring Boot) or by creating the .docx from raw Open XML.

**Simplest approach: create via a quick Java snippet run in a test or main method.**

However, since this is a demo artifact (not used programmatically), the cleanest approach is to create a minimal valid .docx by assembling the Open Packaging Convention ZIP structure:

1. Create directory `src/test/resources/docx/` if it doesn't exist
2. Build a minimal .docx (which is a ZIP) containing:
   - `[Content_Types].xml` — content type definitions
   - `_rels/.rels` — package relationships
   - `word/document.xml` — the document body with:
     - Company header paragraph
     - Address placeholder area: `[Empfänger Name]`, `[Straße]`, `[PLZ Ort]`
     - Date placeholder: `[Datum]`
     - Subject line placeholder: `[Betreff]`
     - Body text paragraph
     - QR code placeholder area: `[QR-Code hier einfügen]`
     - Page break (w:br w:type="page")
     - Page 2: Additional information heading, terms text placeholder
   - `word/_rels/document.xml.rels` — document relationships

The .docx must be a valid ZIP that can be opened in Word/LibreOffice. Use German placeholder text matching the HTML template structure.

**Alternative simpler approach:** If assembling raw XML is complex, use a test utility class or a @Test method with Apache POI XWPFDocument to generate the .docx and copy it to the resources directory. The key requirement is that the file exists as a valid .docx artifact.

Pick whichever approach produces a valid .docx most reliably. Document the approach chosen.
  </action>
  <verify>
Verify .docx exists and is a valid ZIP:
```bash
file src/test/resources/docx/template-a.docx
unzip -t src/test/resources/docx/template-a.docx 2>&1 | head -10
```

Verify it contains expected content:
```bash
unzip -p src/test/resources/docx/template-a.docx word/document.xml 2>/dev/null | head -20
```
  </verify>
  <done>
- template-a.docx exists in src/test/resources/docx/
- File is a valid .docx (ZIP containing word/document.xml)
- Document contains German placeholder text matching the HTML template structure
- Document has a page break creating a 2-page layout
- QR code placeholder area is present
  </done>
</task>

</tasks>

<verification>
1. template-a.html passes XHTML validation (xmllint --noout)
2. template-a.css contains @page, page-break-before, font-family rules
3. template-a.docx is a valid ZIP with word/document.xml
4. All existing tests (9) still pass: `mvn test`
5. Template A can be rendered through the pipeline (quick smoke test):
   - ThymeleafRenderer can process "template-a" without errors
   - PdfGenerator can produce a PDF from the rendered HTML
</verification>

<success_criteria>
- Template A HTML has: address placeholders, QR code img, page break div, 2 conditional th:if blocks, running header/footer (via CSS or body elements)
- Template A CSS has: @page A4 with margins, page-break-before rule, font-family DejaVuSans
- Template A .docx is a valid Word document with matching structure
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-demo-templates/02-01-SUMMARY.md`
</output>
