---
phase: 03-test-suite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/java/com/example/print/TemplateAIntegrationTest.java
  - src/test/java/com/example/print/TemplateBIntegrationTest.java
autonomous: true

must_haves:
  truths:
    - "mvn test produces target/test-output/template-a.pdf"
    - "mvn test produces target/test-output/template-b.pdf"
    - "PDF text extraction finds expected names and addresses in both PDFs"
    - "QR code in Template A PDF is scannable via ZXing and contains expected URL"
  artifacts:
    - path: "src/test/java/com/example/print/TemplateAIntegrationTest.java"
      provides: "Template A PDF generation and verification tests"
      min_lines: 60
    - path: "src/test/java/com/example/print/TemplateBIntegrationTest.java"
      provides: "Template B PDF generation and verification tests"
      min_lines: 40
  key_links:
    - from: "TemplateAIntegrationTest.java"
      to: "templates/template-a.html"
      via: "ThymeleafRenderer.render(\"template-a\", model)"
      pattern: "renderer\\.render\\(\"template-a\""
    - from: "TemplateBIntegrationTest.java"
      to: "templates/template-b.html"
      via: "ThymeleafRenderer.render(\"template-b\", model)"
      pattern: "renderer\\.render\\(\"template-b\""
    - from: "TemplateAIntegrationTest.java"
      to: "QrCodeGenerator"
      via: "QR decode round-trip verification"
      pattern: "QRCodeReader|DecodeHintType"
---

<objective>
Create JUnit integration tests for both Template A and Template B that exercise the full pipeline (QR generation -> Thymeleaf rendering -> PDF generation), write viewable PDFs to target/test-output/, assert on text content via PDFBox, and verify QR code scannability via ZXing decode.

Purpose: Final phase -- prove the end-to-end pipeline works for both real templates with content verification.
Output: Two test classes, all tests green via `mvn test`, two PDF files in target/test-output/.
</objective>

<execution_context>
@/Users/markus/.claude/get-shit-done/workflows/execute-plan.md
@/Users/markus/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/test/java/com/example/print/PipelineIntegrationTest.java
@src/test/resources/templates/template-a.html
@src/test/resources/templates/template-b.html
@src/main/java/com/example/print/qr/QrCodeGenerator.java
@src/main/java/com/example/print/pdf/PdfGenerator.java
@src/main/java/com/example/print/template/ThymeleafRenderer.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Template A integration test with QR verification</name>
  <files>src/test/java/com/example/print/TemplateAIntegrationTest.java</files>
  <action>
Create TemplateAIntegrationTest.java following the exact pattern from PipelineIntegrationTest.java.

The test class should have a shared @BeforeAll that creates target/test-output/ and a helper method that builds the full Template A model and generates the PDF (to avoid duplication across test methods).

Template A model variables (from template-a.html):
- recipientName: "Hans Mueller"
- recipientStreet: "Koenigstrasse 42"
- recipientCity: "80331 Muenchen"
- date: "18. Februar 2026"
- subject: "Betreff: Wichtige Mitteilung"
- bodyText: "Sehr geehrter Herr Mueller, hiermit moechten wir Sie ueber wichtige Aenderungen informieren."
- showNotice: true
- noticeText: "Hinweis: Bitte beachten Sie die beigefuegten Unterlagen."
- qrCodeDataUri: generated via QrCodeGenerator.generateDataUri("https://acme-gmbh.de/doc/A-2026-001", 300)
- senderName: "Dr. Anna Schmidt"
- termsText: "Es gelten die Allgemeinen Geschaeftsbedingungen der ACME GmbH."
- showDisclaimer: true
- disclaimerText: "Haftungsausschluss: Dieses Dokument dient ausschliesslich zu Informationszwecken."
- contactInfo: "Kontakt: info@acme-gmbh.de | Tel: +49 89 123456-0"

Test methods:

1. `testGenerateTemplateAPdf()` -- Renders template-a with ThymeleafRenderer, generates PDF via PdfGenerator, writes to target/test-output/template-a.pdf. Asserts: file exists, starts with %PDF, size > 10KB (has font + QR image). (Covers TEST-01)

2. `testTemplateAContentAssertions()` -- Generates the PDF, loads with PDFBox Loader.loadPDF(byte[]), extracts text with PDFTextStripper. Asserts text contains: "Hans Mueller" (or "Hans Müller" -- use the actual German umlaut characters in the model: "Hans Müller", "Königstraße 42", "80331 München"), "Dr. Anna Schmidt", "ACME GmbH", "Wichtige Mitteilung". (Covers TEST-03 for Template A)

3. `testTemplateAQrCodeScannable()` -- Generates the PDF, uses PDFBox PDFRenderer to render page 0 as BufferedImage at 150 DPI. Then uses ZXing's BinaryBitmap + HybridBinarizer + QRCodeReader to decode the QR code from the rendered page image. Asserts decoded text equals "https://acme-gmbh.de/doc/A-2026-001". This proves the QR code survived the HTML->PDF pipeline and is scannable. (Covers TEST-04)

For the QR scanning test, use these ZXing classes (already in dependencies):
- com.google.zxing.client.j2se.BufferedImageLuminanceSource
- com.google.zxing.common.HybridBinarizer
- com.google.zxing.BinaryBitmap
- com.google.zxing.qrcode.QRCodeReader
- com.google.zxing.Result

For PDF page rendering, use PDFBox:
- org.apache.pdfbox.rendering.PDFRenderer (render page as BufferedImage)

Use German umlaut characters in the model data (Müller, Königstraße, München) to verify Unicode handling end-to-end.

Base URI: getClass().getClassLoader().getResource("").toExternalForm() (root of test-classes, same pattern as PipelineIntegrationTest).
  </action>
  <verify>Run `mvn test -pl . -Dtest=TemplateAIntegrationTest` -- all 3 tests pass. Verify target/test-output/template-a.pdf exists and is > 10KB.</verify>
  <done>Template A PDF generated at target/test-output/template-a.pdf, text content verified (names, addresses), QR code scannable and contains expected URL.</done>
</task>

<task type="auto">
  <name>Task 2: Template B integration test with content assertions</name>
  <files>src/test/java/com/example/print/TemplateBIntegrationTest.java</files>
  <action>
Create TemplateBIntegrationTest.java following the same pattern.

Template B model variables (from template-b.html):
- title: "Produktinformation"
- subtitle: "Premium Dienstleistungspaket"
- productName: "Premium Dienstleistungspaket"
- productDescription: "Unser umfassendes Dienstleistungspaket bietet Ihnen massgeschneiderte Loesungen."
- price: "EUR 2.499,00 zzgl. MwSt."
- availability: "Sofort verfuegbar"
- contactPerson: "Thomas Mueller" (use "Thomas Müller" with umlaut)
- phone: "+49 89 123456-10"
- email: "vertrieb@acme-gmbh.de"
- companyAddress: "ACME GmbH, Innovationsweg 10, 80339 München"
- showSpecialOffer: true
- specialOfferText: "Sonderangebot: 15% Rabatt bei Bestellung bis zum 31.03.2026!"
- footerText: "Alle Preise verstehen sich zzgl. der gesetzlichen Mehrwertsteuer."

Test methods:

1. `testGenerateTemplateBPdf()` -- Renders template-b, generates PDF, writes to target/test-output/template-b.pdf. Asserts: file exists, starts with %PDF, size > 5KB. (Covers TEST-02)

2. `testTemplateBContentAssertions()` -- Generates PDF, extracts text with PDFBox. Asserts text contains: "Thomas Müller", "Produktinformation", "EUR 2.499", "ACME GmbH", "Sonderangebot". (Covers TEST-03 for Template B)

Base URI: same pattern as Task 1.

No QR test needed for Template B (it has no QR code).
  </action>
  <verify>Run `mvn test -Dtest=TemplateBIntegrationTest` -- both tests pass. Verify target/test-output/template-b.pdf exists. Then run full suite: `mvn test` -- all tests pass (existing 9 + new 5 = 14 total).</verify>
  <done>Template B PDF generated at target/test-output/template-b.pdf, text content verified. Full test suite passes with `mvn test`.</done>
</task>

</tasks>

<verification>
1. `mvn test` passes with 0 failures (14 total tests: 9 existing + 3 Template A + 2 Template B)
2. `ls -la target/test-output/template-a.pdf target/test-output/template-b.pdf` -- both files exist
3. Both PDFs are viewable (checkpoint:human-verify after execution if desired)
</verification>

<success_criteria>
- target/test-output/template-a.pdf and target/test-output/template-b.pdf produced by `mvn test`
- PDF content assertions confirm names, addresses, and German text in both PDFs
- QR code in Template A PDF decoded successfully via ZXing, matching the encoded URL
- All 14 tests pass (9 existing + 5 new)
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-suite/03-01-SUMMARY.md`
</output>
